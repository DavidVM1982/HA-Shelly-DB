#-----------------------------------------------------------------------------------------------------------------------
#   Shelly 1
#-----------------------------------------------------------------------------------------------------------------------
# First place al entity's in to labels
# Input (labelname: Input)
#   - total input on
#   - total input off
# Output (labelname: Ouput)
#   - total output aan
#   - total output uit
# Cloud connection (labelname: Cloud)
#   - total cloud connection OK
#   - total cloud connection NOK
# Wifi strength (labelname: rssi)
#   - average rssi
# Firmeware available  (labelname: Firmeware)
#   - total Update OK
#   - total Update NOK
#
#-----------------------------------------------------------------------------------------------------------------------
- sensor:
#---------- input ------------------------------------------------------------------------------------------------------
  ######################################################################################################################
  # total input on
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total input on"
    unique_id: fdcd8a81-95a4-42c0-b64c-4d5dedecf756
    unit_of_measurement: ""
    icon: mdi:toggle-switch
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Input' -%}
      {%- set state = 'on' -%}
      {%- set total = label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}
  ######################################################################################################################
  # total input off
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total input off"
    unique_id: b70064e3-6697-4ba3-bc5c-5b69fdc9d052
    unit_of_measurement: ""
    icon: mdi:toggle-switch-off-outline
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Input' -%}
      {%- set state = 'off' -%}
      {%- set total = label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}

#---------- output -----------------------------------------------------------------------------------------------------
  ######################################################################################################################
  # total output on
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total output on"
    unique_id: 3626e88c-7e7c-461c-9a7c-3991751055e6
    unit_of_measurement: ""
    icon: mdi:power-plug-outline
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Output' -%}
      {%- set state = 'on' -%}
      {%- set total = label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}
  ######################################################################################################################
  # total output off
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total output off"
    unique_id: 346b9320-8999-46cb-994d-a3324bc7cbea
    unit_of_measurement: ""
    icon: mdi:power-plug-off-outline
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Output' -%}
      {%- set state = 'off' -%}
      {%- set total = label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}

#---------- cloud connection -------------------------------------------------------------------------------------------
  ######################################################################################################################
  # total cloud connection OK
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total cloud OK"
    unique_id: 254ea737-1b5b-4029-a6ae-690c7116fbde
    unit_of_measurement: ""
    icon: mdi:cloud-check-variant
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Cloud' -%}
      {%- set state = 'on' -%}
      {%- set total = label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}
  ######################################################################################################################
  # total cloud connection NOK
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total cloud NOK"
    unique_id: e719b6aa-cf2b-4c4b-9fbd-1a7299e60c3a
    unit_of_measurement: ""
    icon: mdi:cloud-off
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Cloud' -%}
      {%- set state = 'off' -%}
      {%- set total = label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}
  
#---------- Wifi strength ----------------------------------------------------------------------------------------------
  ######################################################################################################################
  # average rssi
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - Average rssi"
    unique_id: c69c8c8d-10dc-4a39-8204-0225d806f364
    unit_of_measurement: ""
    icon: mdi:wifi
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'rssi' -%}
      {%- set total = namespace(value=0) -%}
      {%- set sensors = label_entities(label) | select('is_device_attr', 'model', device) | list -%}
      {%- set sensors_count = label_entities(label) | select('is_device_attr', 'model', device) | list | count -%}
      {%- for sensor in sensors -%}
        {%- set total.value = total.value + (states(sensor) | float(0) | round(2)) -%}
      {%- endfor -%}
      {{ (total.value / sensors_count) | round(0) }}

#---------- Firmeware available ----------------------------------------------------------------------------------------
  ######################################################################################################################
  # total update OK
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 - total update OK"
    unique_id: 9222c29d-2642-4f16-92c8-76bb39cf9145
    unit_of_measurement: ""
    icon: mdi:update
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Firmware' -%}
      {%- set state = 'off' -%}
      {%- set total= label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}
  ######################################################################################################################
  # total update NOK
  # 27/12/2024 DVM
  ######################################################################################################################
  - name: "Shelly 1 -total update NOK"
    unique_id: 5b981bf2-19d0-4f32-81cc-8a7c1a56f645
    unit_of_measurement: ""
    icon: mdi:update
    state: >
      {%- set device = 'Shelly 1' -%}
      {%- set label = 'Firmware' -%}
      {%- set state = 'on' -%}
      {%- set total= label_entities(label) | select('is_state', state) | select('is_device_attr', 'model', device) | list | count -%}
      {{ total | round(0) }}
